<?php/** * Created by PhpStorm. * User: tuan * Date: 26/09/2018 * Time: 08:41 */namespace mondel;class AtmDB{    public $conn;    public function __construct($conn)    {        $this->conn = $conn;    }    public function getAll()    {        $sql = "SELECT * FROM transaction_history";        $query = $this->conn->query($sql);        $result = $query->fetchAll();        $posts = [];        foreach ($result as $row) {            $post = new HitoryTable($row['id'], $row['target_id'], $row['source_id'], $row['amount'], $row['content'], $row['datetime'], $row['success']);            $posts[] = $post;        }        return $posts;    }    public function getAllUser()    {        $sql = "SELECT * FROM user_account";        $query = $this->conn->query($sql);        $result = $query->fetchAll();        $posts = [];        foreach ($result as $row) {            $post = new UserTable($row['id'], $row['username'], $row['balance']);            $posts[] = $post;        }        return $posts;    }    public function createTransaction($user1Id, $amount, $user2Id, $date, $content)    {        $this->conn->beginTransaction();        if ($user1Id == $user2Id) {            echo "2 mã bạn nhập trùng nhau ";            $success = 0;        }        $sql = "SELECT `balance` FROM user_account WHERE id = ?";        $query = $this->conn->prepare($sql);        $query->execute([$user1Id]);        $availableAmount = (int)$query->fetchColumn();        if ($availableAmount > $amount) {            $sqlUpdateUser1 = "UPDATE `user_account` SET balance=balance - ? WHERE id = ?";            $query = $this->conn->prepare($sqlUpdateUser1);            $query->execute([$amount, $user1Id]);            $sqlUpdateUser2 = "UPDATE `user_account` SET balance=balance + ? WHERE id = ?";            $query = $this->conn->prepare($sqlUpdateUser2);            $query->execute([$amount, $user2Id]);            $success = 1;        } else {            echo "số tiền của bạn không đủ ";            $success = 0;        };        $update = "INSERT INTO `transaction_history`(`target_id`, `source_id`, `amount`, `content`, `datetime`, `success`) VALUES (?,?,?,?,?,?)";        $query = $this->conn->prepare($update);        $query->execute([$user1Id, $user2Id, $amount, "$content", "$date", $success]);        $this->conn->commit();    }    public function login($userName, $passWord)    {        $this->conn->beginTransaction();        /**         * kiểm tra aser có hay không ;         */        $sql = "SELECT `username` FROM user_account WHERE username = ?";        $query = $this->conn->prepare($sql);        $query->execute(["$userName"]);        $result = $query->fetchAll();        if ($result) {            $sql = "SELECT * FROM user_account AS t1 JOIN pasword AS t2 ON t1.id_password = t2.id WHERE  t1.username = ? AND t2.pasword =?";            $query = $this->conn->prepare($sql);            $query->execute(["$userName", "$passWord"]);            $result = $query->fetchAll();            if ($result) {                return "success";            } else {                return "password";            }        } else {            return "username";        }        $this->conn->commit();    }}